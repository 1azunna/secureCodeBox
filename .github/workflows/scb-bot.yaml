name: Check outdated scanners
on:
  push:
#  schedule:
#    - cron: "0 8 * * *"
jobs:
  version-compare:
    runs-on: ubuntu-latest
    # env:
    #   local: 1
    #   release: 2
    strategy:
      matrix:
        scanner:
          - amass
          - angularjs-csti-scanner
          - gitleaks
          - kube-hunter
          - kubeaudit
          - ncrack
          - nuclei
          - ssh-scan
          - sslyze
          - trivy
          - whatweb
          - wpscan
          - zap
          - zap-advanced 
          # missing scanners are : nmap, nikto, typo3scan
    steps:
      - uses: actions/checkout@v2
   
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v3
        with:
          gpg-private-key: ${{ secrets.GPG_COMMITS_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_COMMITS_PASSPHRASE }}
          git-user-signingkey: true
          git-commit-gpgsign: true

      - name: Fetch scanner's version API
        uses: mikefarah/yq@v4.4.1
        with:
          cmd: echo versionApi=$(yq e .versionApi scanners/${{ matrix.scanner }}/Chart.yaml) >> $GITHUB_ENV 

      - name: Fetch release version
        run: echo release=$((curl -sL ${{env.versionApi}}  ) | jq -r ".tag_name") | tr -d "v" >> $GITHUB_ENV
            
      - name: Fetch local scanner version
        uses: mikefarah/yq@v4.4.1
        with:
          cmd: echo local=$(yq e .appVersion scanners/${{ matrix.scanner }}/Chart.yaml) | tr -d "v" >> $GITHUB_ENV

      - name: Check if outdated  
        if: ${{ env.release != env.local }}          
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | gh auth login --with-token
          echo '${{ matrix.scanner }} scanner is outdated.  scB version is ${{env.local}} and remote version is ${{env.release}}'
          var="pullRequest=test"
          echo pullRequest=$var >> $GITHUB_ENV
          echo prExists=$(gh pr list | grep "${{env.pullRequest}}" -c) >> $GITHUB_ENV 

      - name : Upgrade Scanner
        if: ${{ env.release != env.local && env.prExists == 0 }} 
        uses: mikefarah/yq@v4.4.1
        with:
          cmd: yq e '.appVersion = "${{env.release}}"' ./scanners/${{ matrix.scanner }}/Chart.yaml >> ./scanners/${{ matrix.scanner }}/Chart.yaml

